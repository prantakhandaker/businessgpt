<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BusinessGPT - AI Analytics Assistant</title>
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=S√∂hne:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        /* Layout content width */
        --content-max: 820px;
        /* Spacing scale (8px grid) */
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 20px;
        --space-6: 24px;
        --space-8: 32px;

        /* Radii */
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;

        /* Shadows (3 tiers) */
        --shadow-card: 0 1px 2px 0 rgb(0 0 0 / 0.06), 0 1px 3px 0 rgb(0 0 0 / 0.04);
        --shadow-hover: 0 10px 15px -3px rgb(0 0 0 / 0.10), 0 4px 6px -4px rgb(0 0 0 / 0.08);
        --shadow-modal: 0 20px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.10);
        --primary-color: #0012a9;   /* brand primary */
        --primary-light: #1b2bd6;   /* hover */
        --primary-dark: #000e7f;    /* pressed */
        --secondary-color: #6b7280;
        --accent-color: #10a37f;
        --success-color: #10a37f;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
        --background-primary: #343541;
        --background-secondary: #444654;
        --background-tertiary: #2a2b32;
        --background-sidebar: #202123;
        --background-message-user: #10a37f;
        --background-message-assistant: #444654;
        --text-primary: #ececf1;
        --text-secondary: #c5c5d2;
        --text-muted: #8e8ea0;
        --border-color: #565869;
        --border-light: #4d4d5c;
        --shadow-sm: var(--shadow-card);
        --shadow-md: var(--shadow-hover);
        --shadow-lg: var(--shadow-modal);
        --shadow-xl: var(--shadow-modal);
    }

    /* Light theme overrides */
    [data-theme='light'] {
        --background-primary: #f7f7f9;
        --background-secondary: #ffffff;
        --background-tertiary: #f1f5f9;
        --background-sidebar: #ffffff;
        --background-message-user: #DEEBF7;
        --background-message-assistant: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #374151;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --border-light: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.08);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.12), 0 4px 6px -4px rgb(0 0 0 / 0.08);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.12);
    }

    * {
        box-sizing: border-box;
    }

    body {
        font-family: "S√∂hne", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--background-primary);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        color: var(--text-primary);
        line-height: 1.6;
        font-weight: 400;
        overflow: hidden;
    }



    

    .app-container {
        display: flex;
        height: 100vh;
        width: 100vw;
    }

    .sidebar { display: none; }
    .sidebar-toggle { display: none !important; }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .logo-badge {
        display: flex;
        align-items: center;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: #fff;
        border-radius: var(--radius-lg);
        padding: 12px 16px;
        font-weight: 600;
        font-size: 16px;
        box-shadow: var(--shadow-md);
        gap: 8px;
        transition: all 0.2s ease;
    }

    .logo-badge:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
    }

    .logo-text {
        font-family: inherit;
        font-size: 16px;
        font-weight: 600;
        letter-spacing: -0.025em;
    }

    .icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
    }

    .icon svg {
        width: 18px;
        height: 18px;
        display: block;
        fill: white;
    }

    /* Base UI kit */
    .btn { cursor: pointer; border-radius: var(--radius-md); border: 1px solid var(--border-color); padding: 10px 14px; font-size: 14px; background: var(--background-tertiary); color: var(--text-primary); transition: all .2s ease; }
    .btn:hover { background: var(--background-secondary); border-color: var(--primary-light); box-shadow: var(--shadow-sm); }
    .btn-primary { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .btn-primary:hover { background: var(--primary-light); }

    .chip { display: inline-flex; align-items: center; gap: 8px; border-radius: 999px; padding: 8px 14px; border: 1px solid var(--border-color); background: var(--background-secondary); color: var(--text-secondary); transition: all .2s ease; }
    .chip:hover { background: var(--background-tertiary); color: var(--text-primary); border-color: var(--primary-color); }

    .card { border: 1px solid var(--border-color); border-radius: var(--radius-lg); background: var(--background-secondary); box-shadow: var(--shadow-sm); }

    .new-chat-btn {
        width: 100%;
        margin: 16px 20px 0 20px;
        padding: 12px 16px;
        background: var(--background-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .new-chat-btn:hover {
        background: var(--background-secondary);
        border-color: var(--primary-color);
    }

    .chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }

    .chat-history h3 {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0 0 16px 0;
    }

    .chat-item {
        padding: 12px 16px;
        margin-bottom: 8px;
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-secondary);
        font-size: 14px;
        border: 1px solid transparent;
    }

    .chat-item:hover {
        background: var(--background-tertiary);
        color: var(--text-primary);
    }

    .chat-item.active {
        background: var(--background-secondary);
        color: var(--text-primary);
        border-color: var(--primary-color);
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--background-primary);
    }

    .main-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .header-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: var(--background-tertiary);
        border-radius: var(--radius-lg);
        font-size: 12px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        background: var(--success-color);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    #chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 0;
        background: var(--background-primary);
    }

    .chat-messages {
        max-width: var(--content-max);
        margin: 0 auto;
        padding: 20px;
    }


    .message {
        display: flex;
        gap: 16px;
        margin: 0;
        padding: 24px 0;
        border-bottom: 1px solid var(--border-color);
        animation: messageSlideIn 0.3s ease-out;
        position: relative;
    }

    .message:last-child {
        border-bottom: none;
    }

    .message:hover .message-actions {
        opacity: 1;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
        font-weight: 600;
        overflow: hidden;
    }

    .message.user .message-avatar {
        background: var(--primary-color);
        color: white;
    }

    .message.assistant .message-avatar {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
    }

    .message-content {
        flex: 1;
        font-size: clamp(14px, 1.2vw, 15px);
        line-height: 1.6;
        color: var(--text-primary);
        position: relative;
    }

    .message.user .message-content {
        background: var(--background-message-user);
        color: rgb(11, 10, 10);
        padding: 12px 16px;
        border-radius: var(--radius-lg);
        border-bottom-right-radius: var(--radius-sm);
        margin-left: auto;
        max-width: 70%;
        word-wrap: break-word;
    }

    .message.assistant .message-content {
        background: var(--background-message-assistant);
        padding: 16px 20px;
        border-radius: var(--radius-lg);
        border-bottom-left-radius: var(--radius-sm);
        max-width: 90%;
        word-wrap: break-word;
    }

    .message-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s ease;
        background: var(--background-secondary);
        border-radius: var(--radius-md);
        padding: 4px;
        border: 1px solid var(--border-color);
    }

    .message-action {
        width: 24px;
        height: 24px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .message-action:hover {
        background: var(--background-tertiary);
        color: var(--text-primary);
    }

    .message-action svg {
        width: 14px;
        height: 14px;
    }

    .input-container {
        padding: 20px;
        background: var(--background-primary);
        border-top: 1px solid var(--border-color);
    }

    .input-wrapper {
        max-width: var(--content-max);
        margin: 0 auto;
        position: relative;
    }

    .input-inner {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        background: var(--background-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        padding: 12px;
        transition: all 0.2s ease;
    }

    .input-inner:focus-within {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
    }

    #user-input {
        flex: 1;
        padding: 12px 16px;
        font-size: 15px;
        border: none;
        outline: none;
        background: transparent;
        color: var(--text-primary);
        font-weight: 400;
        resize: none;
        min-height: 24px;
        max-height: 200px;
        line-height: 1.5;
    }

    #user-input::placeholder {
        color: var(--text-muted);
    }

    .send-button {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: var(--primary-color);
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .send-button:hover {
        background: var(--primary-light);
        transform: scale(1.05);
    }

    .send-button:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
        transform: none;
    }

    .suggestions-container {
        max-width: var(--content-max);
        margin: 0 auto 20px auto;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
    }

    .suggestion-btn { background: var(--background-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 14px; border-radius: 999px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all .2s ease; display: inline-flex; align-items: center; gap: 8px; }
    .suggestion-btn:hover, .suggestion-btn:focus { background: var(--background-tertiary); color: var(--text-primary); border-color: var(--primary-color); }

    .collapsible {
        color: var(--text-primary);
        cursor: pointer;
        padding: 16px 20px;
        width: 100%;
        border: 1px solid var(--border-color);
        text-align: left;
        outline: none;
        font-size: 14px;
        font-weight: 500;
        border-radius: var(--radius-lg);
        margin: 16px 0;
        background: var(--background-tertiary);
        transition: all 0.2s ease;
        box-shadow: var(--shadow-sm);
        position: relative;
    }

    .collapsible::after {
        content: '‚ñº';
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        transition: transform 0.2s ease;
        font-size: 12px;
        color: var(--text-muted);
    }

    .active::after {
        transform: translateY(-50%) rotate(180deg);
    }

    .active, .collapsible:hover {
        background: var(--background-secondary);
        border-color: var(--primary-color);
        box-shadow: var(--shadow-md);
    }

    .content {
        overflow: hidden;
        border-radius: var(--radius-lg);
        margin-bottom: 16px;
        background: var(--background-secondary);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
    }

    table {
        border-radius: var(--radius-lg);
        border-collapse: collapse;
        width: 100%;
        margin-top: 16px;
        display: block;
        overflow-x: auto;
        background: var(--background-secondary);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-color);
        table-layout: fixed; /* Prevent oversized columns from breaking layout */
    }

    th, td {
        border: 1px solid var(--border-color);
        padding: 12px 16px;
        text-align: left;
        font-size: 14px;
        word-break: break-word;
        overflow: hidden; /* enable ellipsis via inner wrapper */
    }

    th {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        background: var(--background-secondary);
        color: var(--text-primary);
    }

    tr:nth-child(even) td {
        background: var(--background-tertiary);
    }

    /* Enhanced results table styling */
    .results-table {
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-color);
    }
    
    .table-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
    }
    
    .table-header-cell {
        padding: 12px 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 12px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .table-header-cell:last-child {
        border-right: none;
    }
    
    .table-row {
        transition: background-color 0.2s ease;
    }
    
    .table-row:hover {
        background-color: var(--background-tertiary);
    }
    
    .table-row.even {
        background-color: var(--background-secondary);
    }
    
    .table-row.odd {
        background-color: var(--background-primary);
    }
    
    .table-cell {
        padding: 12px 16px;
        border-right: 1px solid var(--border-light);
        border-bottom: 1px solid var(--border-light);
        vertical-align: top;
    }
    
    .table-cell:last-child {
        border-right: none;
    }
    
    .table-row:last-child .table-cell {
        border-bottom: none;
    }

    /* Sticky header for results table */
    thead th { position: sticky; top: 0; z-index: 1; }

    /* Cell inner for truncation */
    .cell-inner {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .cell-inner.expanded {
        white-space: normal;
        word-break: break-word;
    }

    /* Typing animation */
    .typing {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 16px 20px;
        background: var(--background-message-assistant);
        border-radius: var(--radius-lg);
        border-bottom-left-radius: var(--radius-sm);
        max-width: 90%;
    }

    .typing span {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--text-muted);
        opacity: 0;
        animation: typingDots 1.4s infinite both;
    }
    
    .typing span:nth-child(1) { animation-delay: 0s; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingDots {
        0%, 80%, 100% { 
            opacity: 0;
            transform: scale(0.8);
        }
        40% { 
            opacity: 1;
            transform: scale(1);
        }
    }

    /* Streaming text animation */
    .streaming-text {
        border-right: 2px solid var(--primary-color);
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0%, 50% { border-color: var(--primary-color); }
        51%, 100% { border-color: transparent; }
    }

    /* Mobile sidebar toggle */
    .sidebar-toggle {
        display: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        background: var(--background-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 8px;
        cursor: pointer;
        color: var(--text-primary);
    }

    /* Responsive styles */
    @media (max-width: 1366px) {
        :root { --content-max: 720px; }
        .main-header { padding: 16px 18px; }
        .input-inner { padding: 10px; }
        .send-button { width: 28px; height: 28px; }
        .suggestion-btn { padding: 6px 12px; font-size: 12px; }
        .dashboard-card { min-height: 300px; }
    }

    @media (max-width: 1200px) {
        :root { --content-max: 680px; }
        .dashboard-grid { grid-template-columns: 1fr; }
        .dashboard-card { min-height: 280px; }
    }

    @media (max-width: 992px) {
        :root { --content-max: 640px; }
        .main-header { padding: 12px 14px; }
    }

    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 999;
            transform: translateX(-100%);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-toggle {
            display: block;
        }

        .main-content {
            margin-left: 0;
        }

        .chat-messages {
            padding: 16px;
        }

        .input-container {
            padding: 16px;
        }

        .suggestions-container {
            gap: 6px;
        }

        .suggestion-btn {
            font-size: 12px;
            padding: 6px 12px;
        }
    }

    @media (max-width: 600px) {
        .main-header {
            padding: 16px;
        }
        
        .header-title {
            font-size: 16px;
        }
        
        .chat-messages {
            padding: 12px;
        }
        
        .message {
            padding: 16px 0;
        }
        
        .message-avatar {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        
        .message-content {
            font-size: 14px;
        }
        
        .input-container {
            padding: 12px;
        }
        
        .input-inner {
            padding: 8px;
        }
        
        #user-input {
            font-size: 14px;
            padding: 8px 12px;
        }
        
        .send-button {
            width: 28px;
            height: 28px;
        }
        
        th, td {
            font-size: 12px;
            padding: 8px 12px;
        }
    }

    @media (max-width: 400px) {
        .main-header {
            padding: 12px;
        }
        
        .header-title {
            font-size: 14px;
        }
        
        .chat-messages {
            padding: 8px;
        }
        
        .message {
            padding: 12px 0;
        }
        
        .message-avatar {
            width: 24px;
            height: 24px;
            font-size: 11px;
        }
        
        .message-content {
            font-size: 13px;
        }
        
        .input-container {
            padding: 8px;
        }
        
        .input-inner {
            padding: 6px;
        }
        
        #user-input {
            font-size: 13px;
            padding: 6px 8px;
        }
        
        .send-button {
            width: 24px;
            height: 24px;
        }
        
        th, td {
            font-size: 11px;
            padding: 6px 8px;
        }
    }

    /* Enhanced Enterprise Dashboard Modal */
    .dashboard-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .dashboard-modal {
        width: 95vw;
        height: 90vh;
        max-width: 1400px;
        max-height: 900px;
        background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-tertiary) 100%);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
        animation: slideIn 0.4s ease;
    }
    
    @keyframes slideIn {
        from { 
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to { 
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .dashboard-modal::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        z-index: 1;
    }
    
    .dashboard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, var(--background-tertiary) 0%, var(--background-primary) 100%);
        position: relative;
        z-index: 2;
    }
    
    .dashboard-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }
    
    .dashboard-title { 
        font-weight: 700; 
        color: var(--text-primary); 
        font-size: 20px;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .dashboard-title::before {
        content: 'üìä';
        font-size: 24px;
    }
    
    .dashboard-actions { 
        display: flex; 
        gap: 12px; 
        align-items: center;
    }
    
    .dashboard-btn {
        background: linear-gradient(135deg, var(--background-secondary), var(--background-primary));
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 10px 16px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    
    .dashboard-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .dashboard-btn:hover { 
        border-color: var(--primary-color);
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }
    
    .dashboard-btn:hover::before {
        left: 100%;
    }
    
    .dashboard-btn.primary { 
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light)); 
        border-color: var(--primary-color); 
        color: white;
        box-shadow: var(--shadow-sm);
    }
    
    .dashboard-btn.primary:hover {
        background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }
    
    .dashboard-grid {
        padding: 24px;
        gap: 20px;
        overflow: auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        background: var(--background-secondary);
        position: relative;
    }
    
    .dashboard-card {
        background: linear-gradient(135deg, var(--background-primary) 0%, var(--background-secondary) 100%);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 20px;
        min-height: 360px;
        display: flex;
        flex-direction: column;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-sm);
    }
    
    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary-color);
    }
    
    .dashboard-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    
    /* Enhanced Dashboard Picker Controls */
    .dashboard-picker-controls {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        background: linear-gradient(135deg, var(--background-tertiary) 0%, var(--background-primary) 100%);
        display: flex;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
    }
    
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 200px;
    }
    
    .control-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .control-input {
        background: var(--background-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 10px 12px;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        outline: none;
    }
    
    .control-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 18, 169, 0.1);
        background: var(--background-secondary);
    }
    
    .control-input::placeholder {
        color: var(--text-muted);
        font-weight: 400;
    }
    
    .counter-badge {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        padding: 8px 16px;
        border-radius: var(--radius-md);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: var(--shadow-sm);
        margin-left: auto;
    }
    
    /* Chart Selection Cards */
    .chart-selection-card {
        background: linear-gradient(135deg, var(--background-primary) 0%, var(--background-secondary) 100%);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .chart-selection-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--primary-color);
    }
    
    .chart-selection-card.selected {
        border-color: var(--primary-color);
        background: linear-gradient(135deg, rgba(0, 18, 169, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
        box-shadow: var(--shadow-md);
    }
    
    .chart-selection-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .chart-selection-card.selected::before {
        transform: scaleX(1);
    }
    
    .chart-selection-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    
    .chart-selection-title {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .chart-selection-type {
        background: var(--primary-color);
        color: white;
        padding: 4px 8px;
        border-radius: var(--radius-sm);
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-selection-preview {
        height: 120px;
        background: var(--background-tertiary);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 12px;
        position: relative;
        overflow: hidden;
    }
    
    .chart-selection-preview::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(0, 18, 169, 0.05) 0%, 
            rgba(16, 185, 129, 0.05) 100%);
    }
    
    .chart-selection-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: var(--text-muted);
    }
    
    .chart-selection-checkbox {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        background: var(--background-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .chart-selection-card.selected .chart-selection-checkbox {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }
    
    .chart-selection-checkbox::after {
        content: '‚úì';
        font-size: 12px;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .chart-selection-card.selected .chart-selection-checkbox::after {
        opacity: 1;
    }
    /* Enhanced Enterprise Chart Card */
    .chart-card { 
        border: 1px solid var(--border-color); 
        border-radius: var(--radius-lg); 
        background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-tertiary) 100%);
        box-shadow: var(--shadow-md); 
        overflow: hidden;
        position: relative;
        transition: all 0.3s ease;
    }
    .chart-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-color);
    }
    .chart-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }
    
    .chart-head { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 16px 20px; 
        border-bottom: 1px solid var(--border-color); 
        background: linear-gradient(135deg, var(--background-tertiary) 0%, var(--background-primary) 100%);
        position: relative;
    }
    .chart-head::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }
    
    .chart-title { 
        display: flex; 
        gap: 12px; 
        align-items: center; 
        color: var(--text-primary); 
        font-weight: 700;
        font-size: 16px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
    }
    .chart-title::before {
        content: 'üìä';
        font-size: 18px;
        margin-right: 4px;
    }
    .chart-subtitle { 
        color: var(--text-muted); 
        font-size: 12px; 
        font-weight: 500;
        margin-top: 4px;
    }
    .chart-tools { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
    }
    .chart-select { 
        background: var(--background-secondary); 
        color: var(--text-primary); 
        border: 1px solid var(--border-color); 
        border-radius: var(--radius-md); 
        padding: 8px 12px; 
        font-size: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .chart-select:hover {
        border-color: var(--primary-color);
        background: var(--background-primary);
    }
    .chart-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(0, 18, 169, 0.1);
    }
    
    .chart-btn { 
        background: linear-gradient(135deg, var(--background-secondary), var(--background-primary));
        color: var(--text-primary); 
        border: 1px solid var(--border-color); 
        border-radius: var(--radius-md); 
        padding: 8px 12px; 
        cursor: pointer; 
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    .chart-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        transition: left 0.5s ease;
    }
    .chart-btn:hover { 
        border-color: var(--primary-color);
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
    }
    .chart-btn:hover::before {
        left: 100%;
    }
    .chart-btn:active {
        transform: translateY(0);
    }
    
    .chart-kpi { 
        display: grid; 
        grid-template-columns: auto 1fr; 
        gap: 16px; 
        align-items: center; 
        padding: 16px 20px; 
        border-bottom: 1px solid var(--border-light);
        background: var(--background-primary);
    }
    .kpi-main { 
        font-size: 24px; 
        font-weight: 900; 
        color: var(--text-primary);
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .kpi-delta { 
        font-size: 13px; 
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .kpi-delta.up { 
        color: #10b981; 
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .kpi-delta.down { 
        color: #ef4444; 
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }
    .kpi-spark { 
        height: 32px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
    }
    .chart-body { 
        padding: 20px; 
        background: var(--background-secondary);
        position: relative;
    }
    .chart-body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--border-light), transparent);
    }
    .chart-foot { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 12px 20px; 
        border-top: 1px solid var(--border-color); 
        color: var(--text-muted); 
        font-size: 12px; 
        font-weight: 500;
        background: linear-gradient(135deg, var(--background-tertiary) 0%, var(--background-primary) 100%);
    }
    .chart-foot::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }
    
    /* Enhanced chart container styling */
    .chart-container {
        position: relative;
        overflow: hidden;
        border-radius: var(--radius-lg);
    }
    
    .chart-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(0, 18, 169, 0.02) 0%, 
            rgba(16, 185, 129, 0.02) 100%);
        pointer-events: none;
        z-index: 1;
    }
    
    /* Chart loading state */
    .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--text-muted);
        font-size: 14px;
        font-weight: 500;
    }
    
    .chart-loading::before {
        content: '‚è≥';
        margin-right: 8px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Chart error state */
    .chart-error {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: var(--error-color);
        font-size: 14px;
        font-weight: 500;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: var(--radius-md);
    }
    
    .chart-error::before {
        content: '‚ö†Ô∏è';
        margin-right: 8px;
    }
    
    /* Chart interaction states */
    .chart-container:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-lg);
    }
    
    /* Responsive chart adjustments */
    @media (max-width: 768px) {
        .chart-card {
            margin: 10px 0;
        }
        
        .chart-head {
            padding: 12px 16px;
        }
        
        .chart-body {
            padding: 16px;
        }
        
        .chart-foot {
            padding: 8px 16px;
        }
        
        .chart-title {
            font-size: 14px;
        }
        
        .chart-tools {
            flex-direction: column;
            gap: 4px;
        }
        
        .chart-btn, .chart-select {
            font-size: 11px;
            padding: 6px 8px;
        }
    }
    .dashboard-card h4 { margin: 0 0 8px 0; color: var(--text-primary); font-weight: 600; letter-spacing: 0.2px; }
    /* Enhanced Enterprise KPI tile */
    .kpi-card { 
        display: grid; 
        grid-template-rows: auto 1fr auto auto; 
        gap: 12px; 
        height: 100%; 
        border: 1px solid var(--border-color); 
        border-radius: var(--radius-lg); 
        background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-tertiary) 100%);
        box-shadow: var(--shadow-md); 
        padding: 16px; 
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-color);
    }
    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }
    .kpi-head { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        margin-bottom: 8px;
    }
    .kpi-title { 
        font-weight: 700; 
        color: var(--text-primary); 
        letter-spacing: .3px; 
        font-size: 14px;
        text-transform: uppercase;
    }
    .kpi-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
    }
    .kpi-main-row { 
        display: flex; 
        align-items: baseline; 
        gap: 12px; 
        justify-content: center; 
        padding: 16px 12px; 
        border-radius: var(--radius-md); 
        background: var(--background-primary);
        border: 1px solid var(--border-light);
        position: relative;
    }
    .kpi-value { 
        font-size: 36px; 
        font-weight: 900; 
        color: var(--text-primary); 
        letter-spacing: .5px; 
        text-align: center;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .kpi-delta { 
        font-size: 13px; 
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .kpi-delta.up { 
        color: #10b981; 
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
    }
    .kpi-delta.down { 
        color: #ef4444; 
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
    }
    .kpi-delta::before {
        content: '‚Üó';
        font-size: 10px;
    }
    .kpi-delta.down::before {
        content: '‚Üò';
    }
    .kpi-foot { 
        color: var(--text-muted); 
        font-size: 12px; 
        text-align: center; 
        font-weight: 500;
        padding: 8px 0;
        border-top: 1px solid var(--border-light);
    }
    .kpi-subtitle { 
        font-size: 12px; 
        color: var(--text-muted); 
        margin-top: 8px;
        font-weight: 500;
    }
    .kpi-trend {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        margin-top: 8px;
    }
    .kpi-trend-icon {
        font-size: 16px;
        opacity: 0.7;
    }
    @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

    /* Enhanced Floating Dashboard Button */
    .open-dashboard-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        border: none;
        border-radius: var(--radius-md);
        padding: 12px 18px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 700;
        margin: 16px 0;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .open-dashboard-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .open-dashboard-btn:hover {
        background: linear-gradient(135deg, var(--primary-light), var(--primary-color));
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .open-dashboard-btn:hover::before {
        left: 100%;
    }
    
    .open-dashboard-btn:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
    }
    body.modal-open { overflow: hidden; }

    /* Theme toggle */
    .theme-toggle {
        background: var(--background-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 8px 10px;
        cursor: pointer;
    }

    /* Command palette */
    .command-palette-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 3000;
    }
    .command-palette {
        width: 90%;
        max-width: 560px;
        background: var(--background-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        overflow: hidden;
    }
    .palette-header { padding: 12px; border-bottom: 1px solid var(--border-color); }
    .palette-input {
        width: 100%;
        padding: 12px 14px;
        background: var(--background-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 14px;
    }
    .palette-list { max-height: 280px; overflow: auto; padding: 8px; }
    .palette-item {
        padding: 10px 12px;
        border-radius: var(--radius-md);
        cursor: pointer;
        color: var(--text-secondary);
    }
    .palette-item:hover, .palette-item.active { background: var(--background-tertiary); color: var(--text-primary); }

    /* File upload area */
    .file-upload-area {
        border: 2px dashed var(--border-color);
        border-radius: var(--radius-lg);
        padding: 20px;
        text-align: center;
        color: var(--text-secondary);
        background: var(--background-secondary);
        transition: all 0.2s ease;
    }
    .file-upload-area:hover { border-color: var(--primary-color); }
    .file-upload-area.dragover { border-color: var(--primary-color); background: var(--background-tertiary); color: var(--text-primary); }

    /* Responsive welcome message container */
    .welcome-message { max-height: min(48vh, 520px); overflow: auto; padding-right: 4px; }
    .welcome-message img,
    .welcome-message table,
    .welcome-message pre,
    .welcome-message code { max-width: 100%; }
    .welcome-message table { display: block; overflow-x: auto; }
    @media (max-height: 720px) { .welcome-message { max-height: 44vh; } }
    @media (max-width: 600px) { .welcome-message { max-height: 42vh; } }

    /* Chart selection modal */
    .chart-selection-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2500; }
    .chart-selection-modal { width: 90vw; max-width: 1100px; height: 80vh; background: var(--background-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-xl); box-shadow: var(--shadow-xl); display: flex; flex-direction: column; overflow: hidden; }
    .chart-selection-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border-color); background: var(--background-tertiary); }
    .chart-selection-title { font-weight: 600; color: var(--text-primary); }
    .chart-selection-actions { display: flex; gap: 8px; }
    .chart-selection-btn { background: var(--background-secondary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 6px 10px; cursor: pointer; }
    .chart-selection-btn.primary { background: var(--primary-color); border-color: var(--primary-color); color: #fff; }
    .chart-selection-content { flex: 1; overflow: auto; padding: 16px; }
    .chart-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
    .chart-selection-item { border: 1px solid var(--border-color); border-radius: var(--radius-lg); background: var(--background-primary); padding: 12px; display: grid; grid-template-columns: 24px 1fr; gap: 10px; align-items: start; }
    .chart-selection-info h4 { margin: 0 0 6px 0; color: var(--text-primary); font-size: 14px; }
    .chart-selection-info p { margin: 0 0 4px 0; color: var(--text-secondary); font-size: 12px; }
    .chart-selection-preview { height: 90px; background: var(--background-tertiary); border-radius: var(--radius-md); margin-top: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 12px; }
    .chart-selection-footer { padding: 12px 16px; border-top: 1px solid var(--border-color); background: var(--background-tertiary); display: flex; justify-content: space-between; align-items: center; }
    .selected-count { color: var(--text-secondary); font-size: 13px; }
    /* Enterprise picker layout */
    .chart-selection-layout { display: grid; grid-template-columns: 360px 1fr; gap: 16px; height: calc(100% - 0px); }
    .chart-selection-sidebar { border: 1px solid var(--border-color); border-radius: var(--radius-lg); background: var(--background-secondary); overflow: hidden; display: flex; flex-direction: column; }
    .chart-selection-sidebar .sidebar-head { padding: 10px 12px; border-bottom: 1px solid var(--border-color); background: var(--background-tertiary); font-weight: 600; color: var(--text-primary); }
    .chart-list { overflow: auto; padding: 8px; display: grid; gap: 8px; }
    .chart-list-item { display: grid; grid-template-columns: 24px 1fr; gap: 10px; align-items: center; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--background-primary); padding: 10px; cursor: pointer; transition: border-color .15s ease, background .15s ease; }
    .chart-list-item:hover { border-color: var(--primary-light); }
    .chart-list-item.selected { border-color: var(--primary-color); background: rgba(31,61,179,0.08); }
    .chart-list-item .title { font-weight: 600; color: var(--text-primary); }
    .chart-list-item .meta { color: var(--text-muted); font-size: 12px; margin-top: 2px; }
    .chart-list-item .thumb { height: 70px; border-radius: var(--radius-sm); background: var(--background-tertiary); margin-top: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 12px; }
    .chart-preview { border: 1px solid var(--border-color); border-radius: var(--radius-lg); background: var(--background-secondary); display: grid; grid-template-rows: auto 1fr; overflow: hidden; }
    .chart-preview .preview-head { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border-color); background: var(--background-tertiary); }
    .chart-preview .preview-body { padding: 12px; overflow: auto; display: flex; flex-direction: column; gap: 12px; }
    .chart-preview .preview-canvas { height: 300px; }
    .chart-selection-footer { position: sticky; bottom: 0; display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--background-secondary); border-top: 1px solid var(--border-color); }
    .chart-selection-footer .left { color: var(--text-secondary); font-size: 12px; }
    .chart-selection-footer .right { display: flex; gap: 8px; }
    #pickerSearch, #pickerDashboardName { outline: none; }
    #pickerSearch:focus, #pickerDashboardName:focus { box-shadow: 0 0 0 2px rgba(31,61,179,0.18); border-color: var(--primary-color) !important; }
    @media (max-width: 1100px) { .chart-selection-layout { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div class="app-container">
  <!-- Mobile Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo-badge">
        <span class="icon">
          <svg width="18" height="18" viewBox="0 0 19.59 39.92" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <style>
                .cls-1 {
                  fill: white;
                }
              </style>
            </defs>
            <g id="Layer_1-2" data-name="Layer 1">
              <g>
                <polygon class="cls-1" points="10.14 35.41 13.78 39.86 13.78 0 10.14 0 10.14 35.41"/>
                <polygon class="cls-1" points="5.07 29.54 8.71 33.98 8.71 0 5.07 0 5.07 29.54"/>
                <polygon class="cls-1" points="0 14.18 3.64 18.59 3.64 0 0 0 0 14.18"/>
                <rect class="cls-1" x="15.21" y="14.95" width="4.39" height="3.64"/>
                <rect class="cls-1" x="15.21" y="36.28" width="4.39" height="3.64"/>
                <rect class="cls-1" x="15.21" y="31.21" width="4.39" height="3.64"/>
              </g>
            </g>
          </svg>
        </span>
        <span class="logo-text">BusinessGPT</span>
      </div>
    </div>
    
    <button class="new-chat-btn" onclick="startNewChat()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      New Chat
    </button>
    
    <div class="chat-history">
      <h3>Recent</h3>
      <div class="chat-item active">Current Session</div>
      <div class="chat-item">Sales Analysis</div>
      <div class="chat-item">Client Report</div>
      <div class="chat-item">Revenue Trends</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="main-header">
      <div class="logo-badge">
        <span class="icon">
          <svg width="18" height="18" viewBox="0 0 56 56" xmlns="http://www.w3.org/2000/svg">
            <path d="M 26.6875 12.6602 C 26.9687 12.6602 27.1094 12.4961 27.1797 12.2383 C 27.9062 8.3242 27.8594 8.2305 31.9375 7.4570 C 32.2187 7.4102 32.3828 7.2461 32.3828 6.9648 C 32.3828 6.6836 32.2187 6.5195 31.9375 6.4726 C 27.8828 5.6524 28.0000 5.5586 27.1797 1.6914 C 27.1094 1.4336 26.9687 1.2695 26.6875 1.2695 C 26.4062 1.2695 26.2656 1.4336 26.1953 1.6914 C 25.3750 5.5586 25.5156 5.6524 21.4375 6.4726 C 21.1797 6.5195 20.9922 6.6836 20.9922 6.9648 C 20.9922 7.2461 21.1797 7.4102 21.4375 7.4570 C 25.5156 8.2774 25.4687 8.3242 26.1953 12.2383 C 26.2656 12.4961 26.4062 12.6602 26.6875 12.6602 Z M 15.3438 28.7852 C 15.7891 28.7852 16.0938 28.5039 16.1406 28.0821 C 16.9844 21.8242 17.1953 21.8242 23.6641 20.5821 C 24.0860 20.5117 24.3906 20.2305 24.3906 19.7852 C 24.3906 19.3633 24.0860 19.0586 23.6641 18.9883 C 17.1953 18.0977 16.9609 17.8867 16.1406 11.5117 C 16.0938 11.0899 15.7891 10.7852 15.3438 10.7852 C 14.9219 10.7852 14.6172 11.0899 14.5703 11.5352 C 13.7969 17.8164 13.4687 17.7930 7.0469 18.9883 C 6.6250 19.0821 6.3203 19.3633 6.3203 19.7852 C 6.3203 20.2539 6.6250 20.5117 7.1406 20.5821 C 13.5156 21.6133 13.7969 21.7774 14.5703 28.0352 C 14.6172 28.5039 14.9219 28.7852 15.3438 28.7852 Z M 31.2344 54.7305 C 31.8438 54.7305 32.2891 54.2852 32.4062 53.6524 C 34.0703 40.8086 35.8750 38.8633 48.5781 37.4570 C 49.2344 37.3867 49.6797 36.8945 49.6797 36.2852 C 49.6797 35.6758 49.2344 35.2070 48.5781 35.1133 C 35.8750 33.7070 34.0703 31.7617 32.4062 18.9180 C 32.2891 18.2852 31.8438 17.8633 31.2344 17.8633 C 30.6250 17.8633 30.1797 18.2852 30.0860 18.9180 C 28.4219 31.7617 26.5938 33.7070 13.9140 35.1133 C 13.2344 35.2070 12.7891 35.6758 12.7891 36.2852 C 12.7891 36.8945 13.2344 37.3867 13.9140 37.4570 C 26.5703 39.1211 28.3281 40.8321 30.0860 53.6524 C 30.1797 54.2852 30.6250 54.7305 31.2344 54.7305 Z" fill="white"/>
          </svg>
        </span>
        <span class="logo-text">BusinessGPT</span>
      </div>
      <div class="header-actions">
        <!-- <button class="theme-toggle" id="densityToggle" title="Toggle density">‚ÜïÔ∏è</button> -->
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span>Online</span>
        </div>
      </div>
    </div>

    <div id="chat-container">
      <div class="chat-messages" id="chat-messages">
        <!-- Messages will be added here -->
      </div>
    </div>

    <div class="input-container">
      <div class="suggestions-container">
        <button class="suggestion-btn chip">üìä Top 10 Clients</button>
        <button class="suggestion-btn chip">üè¢ Top Depots</button>
        <button class="suggestion-btn chip">üí∞ Today's Sales</button>
        <button class="suggestion-btn chip">üì¶ Top Products</button>
        <button class="suggestion-btn chip">üìà Revenue Last Month</button>
        <!-- <button class="suggestion-btn chip">üíé Profit This Year</button> -->
      </div>
      
      <div class="input-wrapper">
        <div class="input-inner">
          <textarea id="user-input" placeholder="Ask a business question..." rows="1"></textarea>
          <input type="file" id="fileInput" multiple accept=".pdf,.xlsx,.xls,.csv,.txt" style="display:none;" />
          <button class="send-button" id="fileBrowseBtn" title="Upload files" onclick="document.getElementById('fileInput').click()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M4 17V19C4 20.1046 4.89543 21 6 21H18C19.1046 21 20 20.1046 20 19V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7 9L12 4L17 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 4V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <button class="send-button" id="dashboardBtn" title="Dashboards" onclick="openDashboardPicker()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 13H11V3H3V13ZM3 21H11V15H3V21ZM13 21H21V11H13V21ZM13 3V9H21V3H13Z" fill="currentColor"/>
            </svg>
          </button>
          <button class="send-button" onclick="sendMessage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Command Palette -->
<div id="commandPaletteOverlay" class="command-palette-overlay" onclick="closeCommandPalette(event)">
  <div class="command-palette" onclick="event.stopPropagation()">
    <div class="palette-header">
      <input id="paletteInput" class="palette-input" placeholder="Type a command (Upload, Export, Dashboard, Clear)" />
    </div>
    <div id="paletteList" class="palette-list">
      <div class="palette-item" data-action="upload">üìÅ Upload File</div>
      <div class="palette-item" data-action="export">üìÑ Export Chat</div>
      <div class="palette-item" data-action="chart-selection">üìä Create Dashboard</div>
      <div class="palette-item" data-action="dashboard">üìà Open Dashboard</div>
      <div class="palette-item" data-action="clear">üóëÔ∏è Clear Chat</div>
    </div>
  </div>
  </div>

  <!-- Enhanced Dashboard Picker Modal -->
  <div id="dashboardPickerOverlay" class="dashboard-overlay" style="display:none;" onclick="closeDashboardPicker(event)">
    <div class="dashboard-modal" onclick="event.stopPropagation()">
      <div class="dashboard-header">
        <div class="dashboard-title">Create Dashboard</div>
        <div class="dashboard-actions">
          <button class="dashboard-btn primary" id="pickerCreateBtn" onclick="createDashboardFromSelection()" disabled>
            <span>üöÄ</span> Create Dashboard
          </button>
          <button class="dashboard-btn" onclick="closeDashboardPicker()">
            <span>‚úï</span> Close
          </button>
        </div>
      </div>
      <div class="dashboard-picker-controls">
        <div class="control-group">
          <label for="pickerDashboardName" class="control-label">Dashboard Name</label>
          <input id="pickerDashboardName" placeholder="My Custom Dashboard" class="control-input" />
        </div>
        <div class="control-group">
          <label for="pickerSearch" class="control-label">Search Charts</label>
          <input id="pickerSearch" placeholder="Search charts..." oninput="filterPickerCharts()" class="control-input" />
        </div>
        <div class="control-group">
          <span id="pickerCounter" class="counter-badge">0 selected</span>
        </div>
      </div>
      <div class="dashboard-grid" id="dashboardPickerGrid">
        <!-- Filled dynamically -->
      </div>
    </div>
  </div>

<!-- Dashboard Modal -->
<div id="dashboardOverlay" class="dashboard-overlay" onclick="closeDashboard(event)">
  <div class="dashboard-modal" onclick="event.stopPropagation()">
    <div class="dashboard-header">
      <div class="dashboard-title">Dashboard</div>
      <div class="dashboard-actions">
        <button class="dashboard-btn" onclick="downloadDashboardPng()">Download PNG</button>
        <button class="dashboard-btn" onclick="closeDashboard()">Close</button>
      </div>
    </div>
    <div id="dashboardGrid" class="dashboard-grid"></div>
  </div>
  </div>

<script>
const API_BASE = (window.location.origin.startsWith('file:') || window.location.port === '3000') ? 'http://localhost:5000' : window.location.origin;
const chatMessages = document.getElementById('chat-messages');
let currentStreamingMessage = null;

// Per-refresh session scoping: charts saved/visible only for this page load
const USER_ID = 'default';
const SESSION_ID = (() => {
    try {
        let sid = sessionStorage.getItem('businessgpt_session_id');
        if (!sid) {
            sid = 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
            sessionStorage.setItem('businessgpt_session_id', sid);
        }
        return sid;
    } catch (e) {
        return 'sess_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
})();

// Load Google Charts
google.charts.load('current', { packages: ['corechart'] });

// Configure marked for markdown rendering
marked.setOptions({
    breaks: true,
    gfm: true,
    sanitize: false
});

// Auto-resize textarea
const textarea = document.getElementById('user-input');
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

// Pre-suggestion buttons
document.querySelectorAll('.suggestion-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const input = document.getElementById('user-input');
        input.value = btn.textContent;
        sendMessage();
    });
});

function startNewChat() {
    chatMessages.innerHTML = '';
    document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
    document.querySelector('.chat-item').classList.add('active');
    currentStreamingMessage = null;
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
}

function createMessageElement(role, content = '', isStreaming = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    
    avatar.textContent = role === 'user' ? 'U' : 'A';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    
    if (content) {
        if (role === 'assistant') {
            contentDiv.innerHTML = marked.parse(content);
        } else {
            contentDiv.textContent = content;
        }
    }
    
    if (isStreaming) {
        contentDiv.classList.add('streaming-text');
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentDiv);
    
    // Add message actions for assistant messages
    if (role === 'assistant') {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions';
        
        const copyBtn = document.createElement('button');
        copyBtn.className = 'message-action';
        copyBtn.title = 'Copy message';
        copyBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" fill="currentColor"/>
            </svg>
        `;
        copyBtn.onclick = () => copyMessage(contentDiv);
        
        const regenerateBtn = document.createElement('button');
        regenerateBtn.className = 'message-action';
        regenerateBtn.title = 'Regenerate response';
        regenerateBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12S7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12S8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
            </svg>
        `;
        regenerateBtn.onclick = () => regenerateMessage(messageDiv);
        
        actionsDiv.appendChild(copyBtn);
        actionsDiv.appendChild(regenerateBtn);
        messageDiv.appendChild(actionsDiv);
    }
    
    return { messageDiv, contentDiv };
}

function copyMessage(contentDiv) {
    const text = contentDiv.innerText || contentDiv.textContent;
    navigator.clipboard.writeText(text).then(() => {
        // Show brief success feedback
        const button = event.target.closest('.message-action');
        const originalHTML = button.innerHTML;
        button.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="currentColor"/>
            </svg>
        `;
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 1000);
    });
}

function regenerateMessage(messageElement) {
    // Find the previous user message
    const messages = Array.from(chatMessages.children);
    const messageIndex = messages.indexOf(messageElement);
    let userMessage = null;
    
    for (let i = messageIndex - 1; i >= 0; i--) {
        if (messages[i].classList.contains('user')) {
            userMessage = messages[i];
            break;
        }
    }
    
    if (userMessage) {
        // Remove the current assistant message and any messages after it
        const currentIndex = messages.indexOf(messageElement);
        for (let i = currentIndex; i < messages.length; i++) {
            if (messages[i]) {
                messages[i].remove();
            }
        }
        
        // Get the user's question and resend
        const userContent = userMessage.querySelector('.message-content').textContent;
        sendMessage(userContent);
    }
}

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage(questionText = null) {
    const input = document.getElementById('user-input');
    const question = questionText || input.value.trim();
    if (!question) return;

    // Clear input and reset height
    if (!questionText) {
        input.value = '';
        input.style.height = 'auto';
    }

    // Create user message
    const { messageDiv: userMessage } = createMessageElement('user', question);
    chatMessages.appendChild(userMessage);
    scrollToBottom();

    // Create assistant message with typing animation
    const { messageDiv: assistantMessage, contentDiv } = createMessageElement('assistant');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'typing';
    typingDiv.innerHTML = '<span></span><span></span><span></span>';
    contentDiv.appendChild(typingDiv);
    chatMessages.appendChild(assistantMessage);
    scrollToBottom();

    try {
        const response = await fetch(`${API_BASE}/ask`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question, user_id: USER_ID, session_id: SESSION_ID })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();

        // Remove typing animation
        contentDiv.innerHTML = '';
        contentDiv.classList.add('streaming-text');
        currentStreamingMessage = contentDiv;

        // Stream the response text
        let fullContent = '';
        
        // Add category indicator if available
        if (data.metadata && data.metadata.category) {
            const categoryEmoji = {
                'business': 'üìä',
                'smalltalk': 'üí¨', 
                'non_business': 'üö´'
            };
            const categoryName = {
                'business': 'Business Question',
                'smalltalk': 'Personal Chat',
                'non_business': 'Non-Business Topic'
            };
            
            fullContent += `*${categoryEmoji[data.metadata.category]} ${categoryName[data.metadata.category]}*\n\n`;
        }
        
        if (data.answer) {
            fullContent += data.answer;
        }

        if (data.summary) {
            fullContent += `\n\n---\n\n${data.summary}`;
        }

        if (data.error) {
            fullContent += `\n\n‚ö†Ô∏è **Error:** ${data.error}`;
        }
        
        // Add follow-up questions if available
        if (data.follow_up && Array.isArray(data.follow_up) && data.follow_up.length > 0) {
            fullContent += `\n\n**Follow-up questions:**\n`;
            data.follow_up.forEach((question, index) => {
                fullContent += `- ${question}\n`;
            });
        }
        
        // Display depot name corrections if available
        if (data.correction_info && Object.keys(data.correction_info).length > 0) {
            fullContent += `\n\n**Depot name corrections:**\n`;
            for (const [original, info] of Object.entries(data.correction_info)) {
                fullContent += `- "${original}" corrected to "${info.corrected_to}"\n`;
            }
        }

        // Simulate streaming by adding content progressively
        await streamText(contentDiv, fullContent);

        // Add additional content (SQL, tables, charts)
        await addAdditionalContent(contentDiv, data);
        
        // Charts are automatically saved by backend when generated

        // Remove streaming animation
        contentDiv.classList.remove('streaming-text');
        currentStreamingMessage = null;
        scrollToBottom();

    } catch (err) {
        console.error('Error:', err);
        contentDiv.innerHTML = '';
        contentDiv.innerHTML = `<div style="color: var(--error-color);">‚ùå Error connecting to server: ${err.message}</div>`;
        contentDiv.classList.remove('streaming-text');
        currentStreamingMessage = null;
    }
}

async function streamText(contentDiv, text) {
    const words = text.split(' ');
    let currentText = '';
    
    for (let i = 0; i < words.length; i++) {
        currentText += (i > 0 ? ' ' : '') + words[i];
        contentDiv.innerHTML = marked.parse(currentText);
        scrollToBottom();
        
        // Add a small delay to simulate streaming
        await new Promise(resolve => setTimeout(resolve, 50));
    }
}

async function addAdditionalContent(contentDiv, data) {
    // Add SQL section
    if (data.generated_sql) {
        const sqlSection = document.createElement('div');
        sqlSection.style.marginTop = '20px';
        
        const sqlBtn = document.createElement('button');
        sqlBtn.textContent = 'üìä Show Generated SQL';
        sqlBtn.className = 'collapsible';
        sqlBtn.style.marginBottom = '10px';
        
        const sqlContent = document.createElement('div');
        sqlContent.className = 'content';
        sqlContent.style.display = 'none';
        
        const sqlPre = document.createElement('pre');
        sqlPre.style.background = 'var(--background-tertiary)';
        sqlPre.style.padding = '16px';
        sqlPre.style.borderRadius = 'var(--radius-md)';
        sqlPre.style.overflow = 'auto';
        sqlPre.style.fontSize = '14px';
        sqlPre.style.lineHeight = '1.4';
        sqlPre.textContent = data.generated_sql;
        
        sqlContent.appendChild(sqlPre);
        sqlSection.appendChild(sqlBtn);
        sqlSection.appendChild(sqlContent);
        contentDiv.appendChild(sqlSection);

        sqlBtn.addEventListener('click', function() {
            this.classList.toggle('active');
            sqlContent.style.display = sqlContent.style.display === 'block' ? 'none' : 'block';
        });
    }

    // Add results table
    if (data.results && data.results.length > 0) {
        const tableSection = document.createElement('div');
        tableSection.style.marginTop = '20px';
        
        const resBtn = document.createElement('button');
        resBtn.textContent = `üìã Show Results (${data.results.length} rows)`;
        resBtn.className = 'collapsible';
        resBtn.style.marginBottom = '10px';
        
        const resContent = document.createElement('div');
        resContent.className = 'content';
        resContent.style.display = 'none';
        resContent.style.overflow = 'auto';
        resContent.style.maxHeight = '400px';

        const table = document.createElement('table');
        table.className = 'results-table';
        const keys = Object.keys(data.results[0]);
        
        // Create header with enhanced styling
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.className = 'table-header';
        keys.forEach(k => {
            const th = document.createElement('th');
            th.className = 'table-header-cell';
            th.style.fontWeight = '600';
            th.style.textTransform = 'uppercase';
            th.style.letterSpacing = '0.5px';
            const inner = document.createElement('div');
            inner.className = 'cell-inner';
            inner.textContent = k;
            inner.title = k;
            th.appendChild(inner);
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create body with enhanced styling
        const tbody = document.createElement('tbody');
        tbody.className = 'table-body';
        data.results.slice(0, 100).forEach((row, index) => { // Limit to 100 rows for performance
            const tr = document.createElement('tr');
            tr.className = `table-row ${index % 2 === 0 ? 'even' : 'odd'}`;
            keys.forEach(k => {
                const td = document.createElement('td');
                td.className = 'table-cell';
                const value = row[k];
                
                // Enhanced value formatting
                let displayValue = '';
                if (value !== null && value !== undefined) {
                    if (typeof value === 'number') {
                        displayValue = value.toLocaleString();
                        td.style.textAlign = 'right';
                        td.style.fontFamily = 'monospace';
                    } else if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                        displayValue = new Date(value).toLocaleDateString();
                        td.style.textAlign = 'center';
                    } else {
                        displayValue = value.toString();
                    }
                } else {
                    displayValue = '';
                    td.style.color = 'var(--text-muted)';
                    td.style.fontStyle = 'italic';
                }
                
                const wrap = document.createElement('div');
                wrap.className = 'cell-inner';
                wrap.textContent = displayValue;
                wrap.title = displayValue;
                td.appendChild(wrap);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        
        if (data.results.length > 100) {
            const note = document.createElement('p');
            note.style.color = 'var(--text-muted)';
            note.style.fontSize = '14px';
            note.style.marginTop = '10px';
            note.textContent = `Showing first 100 of ${data.results.length} results`;
            resContent.appendChild(note);
        }

        // Add download button for results table
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = 'üì• Download CSV';
        downloadBtn.className = 'chart-btn';
        downloadBtn.style.marginLeft = '10px';
        downloadBtn.onclick = () => downloadResultsAsCSV(data.results, data.query || 'results');
        
        resBtn.appendChild(downloadBtn);
        resContent.appendChild(table);
        tableSection.appendChild(resBtn);
        tableSection.appendChild(resContent);
        contentDiv.appendChild(tableSection);

        resBtn.addEventListener('click', function(e) {
            // Don't toggle if download button is clicked
            if (e.target === downloadBtn) return;
            
            this.classList.toggle('active');
            resContent.style.display = resContent.style.display === 'block' ? 'none' : 'block';
        });
    }

    // Add SQL display
    if (data.generated_sql) {
        const sqlSection = document.createElement('div');
        sqlSection.style.marginTop = '20px';
        
        const sqlBtn = document.createElement('button');
        sqlBtn.textContent = 'üìä Show Generated SQL';
        sqlBtn.className = 'collapsible';
        sqlBtn.style.marginBottom = '10px';
        
        const sqlContent = document.createElement('div');
        sqlContent.className = 'content';
        sqlContent.style.display = 'none';
        sqlContent.style.overflow = 'auto';
        sqlContent.style.maxHeight = '400px';
        sqlContent.style.backgroundColor = '#f8f9fa';
        sqlContent.style.border = '1px solid #e9ecef';
        sqlContent.style.borderRadius = '8px';
        sqlContent.style.padding = '15px';

        const sqlPre = document.createElement('pre');
        sqlPre.style.margin = '0';
        sqlPre.style.fontFamily = 'Monaco, Consolas, "Courier New", monospace';
        sqlPre.style.fontSize = '14px';
        sqlPre.style.lineHeight = '1.4';
        sqlPre.style.color = '#2d3748';
        sqlPre.style.whiteSpace = 'pre-wrap';
        sqlPre.style.wordBreak = 'break-word';
        
        const sqlCode = document.createElement('code');
        sqlCode.textContent = data.generated_sql;
        sqlPre.appendChild(sqlCode);
        sqlContent.appendChild(sqlPre);

        // Add copy button
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'üìã Copy SQL';
        copyBtn.className = 'chart-btn';
        copyBtn.style.marginTop = '10px';
        copyBtn.onclick = () => copySqlToClipboard(data.generated_sql);
        sqlContent.appendChild(copyBtn);

        sqlSection.appendChild(sqlBtn);
        sqlSection.appendChild(sqlContent);
        contentDiv.appendChild(sqlSection);

        sqlBtn.addEventListener('click', function() {
            this.classList.toggle('active');
            sqlContent.style.display = sqlContent.style.display === 'block' ? 'none' : 'block';
        });
    }

    // Add charts
    if (data.charts && data.charts.length > 0) {
        let renderedCharts = [];
        data.charts.forEach((chart, index) => {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-card';
            chartContainer.style.width = '100%';
            chartContainer.style.maxWidth = '800px';
            chartContainer.style.margin = '24px 0';
            chartContainer.style.position = 'relative';

            const chartHeader = document.createElement('div');
            chartHeader.className = 'chart-head';
            
            const chartTitle = document.createElement('h3');
            chartTitle.textContent = chart.title || `Chart ${index + 1}`;
            chartTitle.className = 'chart-title';
            chartTitle.style.margin = '0';
            chartTitle.style.fontSize = '16px';
            
            const chartSelect = document.createElement('select');
            chartSelect.className = 'chart-select';

            const headerRight = document.createElement('div');
            headerRight.className = 'chart-tools';

            // If single-value chart, force box-plot style (we will render a simple boxed KPI)
            const isSingleValue = Array.isArray(chart.values) && chart.values.length === 1;
            const allowedTypes = isSingleValue ? ['kpi'] : ['bar', 'line', 'pie'];
            allowedTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                if ((isSingleValue && type === 'kpi') || (!isSingleValue && type === chart.type)) option.selected = true;
                chartSelect.appendChild(option);
            });
            
            const timeframe = document.createElement('select');
            timeframe.className = 'chart-select';
            ;['Last 7 days','Last 30 days','Last 90 days','YTD'].forEach(v=>{ const o=document.createElement('option'); o.textContent=v; timeframe.appendChild(o); });

            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'chart-btn';
            downloadBtn.textContent = 'Download PNG';

            chartHeader.appendChild(chartTitle);
            headerRight.appendChild(chartSelect);
            headerRight.appendChild(timeframe);
            headerRight.appendChild(downloadBtn);
            chartHeader.appendChild(headerRight);
            chartContainer.appendChild(chartHeader);

            // KPI strip
            const kpiStrip = document.createElement('div');
            kpiStrip.className = 'chart-kpi';
            const kpiMain = document.createElement('div'); kpiMain.className = 'kpi-main';
            const kpiVal = Array.isArray(chart.values) ? chart.values.reduce((a,b)=>a+(Number(b)||0),0) : (Number(chart.values)||0);
            kpiMain.textContent = isNaN(kpiVal) ? '' : formatShortNumber(kpiVal);
            const spark = document.createElement('div');
            spark.className = 'kpi-spark';
            kpiStrip.appendChild(kpiMain);
            kpiStrip.appendChild(spark);
            chartContainer.appendChild(kpiStrip);

            const bodyWrap = document.createElement('div');
            bodyWrap.className = 'chart-body';
            const canvas = document.createElement('div');
            canvas.className = 'chart-container';
            canvas.style.width = '100%';
            canvas.style.height = '360px';
            canvas.style.position = 'relative';
            bodyWrap.appendChild(canvas);
            chartContainer.appendChild(bodyWrap);
            contentDiv.appendChild(chartContainer);

            let myChart = renderChartOrKpi(canvas, chart);
            downloadBtn.onclick = () => {
                if (myChart && typeof myChart.download === 'function') {
                    myChart.download(chart.title || `chart-${index + 1}`);
                }
            };

            chartSelect.addEventListener('change', () => {
                if (myChart && typeof myChart.destroy === 'function') myChart.destroy();
                if (chartSelect.value === 'kpi') {
                    myChart = renderKpi(canvas, chart);
                } else {
                    myChart = renderGoogleChart(canvas, { ...chart, type: chartSelect.value });
                }
                downloadBtn.onclick = () => {
                    if (myChart && typeof myChart.download === 'function') {
                        myChart.download(chart.title || `chart-${index + 1}`);
                    }
                };
            });

            // Collect chart config for dashboard
            renderedCharts.push({
                title: chart.title || `Chart ${index + 1}`,
                labels: chart.labels,
                values: chart.values,
                type: (isSingleValue ? 'kpi' : chart.type)
            });
            // Footer metadata
            const foot = document.createElement('div');
            foot.className = 'chart-foot';
            foot.innerHTML = `<span>Updated just now</span><div></div>`;
            chartContainer.appendChild(foot);
        });

        // Dashboard open button if more than one chart
        if (renderedCharts.length > 1) {
            const dashBtn = document.createElement('button');
            dashBtn.textContent = 'üß© Open as Dashboard';
            dashBtn.className = 'open-dashboard-btn';
            dashBtn.onclick = (e) => { e.stopPropagation(); openDashboard(renderedCharts); };
            contentDiv.appendChild(dashBtn);
        }
    }
}

// Dashboard helpers
function renderKpi(target, chart) {
    // Render an enhanced enterprise KPI tile
    const value = Array.isArray(chart.values) ? chart.values[0] : chart.values;
    const previousValue = chart.meta?.comparison_values ? 
        chart.meta.comparison_values.reduce((a, b) => a + (Number(b) || 0), 0) : null;
    
    target.innerHTML = '';
    const box = document.createElement('div'); 
    box.className = 'kpi-card';
    
    // Header with icon and title
    const head = document.createElement('div'); 
    head.className = 'kpi-head';
    
    const title = document.createElement('div'); 
    title.className = 'kpi-title'; 
    title.textContent = chart.title || 'KPI';
    
    const icon = document.createElement('div'); 
    icon.className = 'kpi-icon';
    icon.textContent = getKpiIcon(chart.title || '');
    
    head.appendChild(title);
    head.appendChild(icon);
    
    // Main value section
    const main = document.createElement('div'); 
    main.className = 'kpi-main-row';
    
    const val = document.createElement('div'); 
    val.className = 'kpi-value'; 
    val.textContent = formatShortNumber(value);
    
    // Delta calculation and display
    if (previousValue !== null && previousValue !== 0) {
        const delta = ((value - previousValue) / previousValue) * 100;
        const deltaEl = document.createElement('div');
        deltaEl.className = `kpi-delta ${delta >= 0 ? 'up' : 'down'}`;
        deltaEl.textContent = `${Math.abs(delta).toFixed(1)}%`;
        main.appendChild(deltaEl);
    }
    
    main.appendChild(val);
    
    // Trend indicator
    if (chart.meta?.delta_pct !== undefined) {
        const trend = document.createElement('div');
        trend.className = 'kpi-trend';
        const trendIcon = document.createElement('span');
        trendIcon.className = 'kpi-trend-icon';
        trendIcon.textContent = chart.meta.delta_pct >= 0 ? 'üìà' : 'üìâ';
        trend.appendChild(trendIcon);
        main.appendChild(trend);
    }
    
    // Footer with subtitle
    const foot = document.createElement('div'); 
    foot.className = 'kpi-foot'; 
    foot.textContent = chart.subtitle || 'Updated just now';
    
    // Subtitle with additional info
    if (chart.meta?.is_time_series) {
        const subtitle = document.createElement('div');
        subtitle.className = 'kpi-subtitle';
        subtitle.textContent = 'Time Series Data';
        foot.appendChild(subtitle);
    }
    
    box.appendChild(head);
    box.appendChild(main);
    box.appendChild(foot);
    target.appendChild(box);
    
    return { 
        destroy: () => { target.innerHTML = ''; },
        download: (name='kpi') => {
            const bg = getComputedStyle(document.documentElement).getPropertyValue('--background-secondary').trim() || '#ffffff';
            html2canvas(target, { backgroundColor: bg, useCORS: true, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${name}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    };
}

function getKpiIcon(title) {
    const titleLower = title.toLowerCase();
    if (titleLower.includes('sales') || titleLower.includes('revenue')) return 'üí∞';
    if (titleLower.includes('profit') || titleLower.includes('margin')) return 'üìä';
    if (titleLower.includes('client') || titleLower.includes('customer')) return 'üë•';
    if (titleLower.includes('product') || titleLower.includes('item')) return 'üì¶';
    if (titleLower.includes('depot') || titleLower.includes('warehouse')) return 'üè¢';
    if (titleLower.includes('quantity') || titleLower.includes('volume')) return 'üìà';
    if (titleLower.includes('growth') || titleLower.includes('trend')) return 'üöÄ';
    return 'üìä';
}

function renderChartOrKpi(target, chart) {
    const isSingleValue = Array.isArray(chart.values) && chart.values.length === 1;
    if (isSingleValue) {
        return renderKpi(target, chart);
    }
    return renderGoogleChart(target, chart);
}

function renderGoogleChart(target, chart) {
    // --- Intelligent preprocessing ---
    const rawLabels = (chart.labels || []).map(l => String(l));
    const rawValues = (chart.values || []).map(v => Number(v || 0));

    const isParsableDate = (s) => {
        const d = new Date(s);
        return !isNaN(d.getTime());
    };
    const isTimeSeries = rawLabels.length > 1 && rawLabels.every(isParsableDate);

    // Top-N + Other for long categorical lists
    let labels = rawLabels.slice();
    let values = rawValues.slice();
    if (!isTimeSeries && labels.length > 12) {
        const indexed = labels.map((l,i)=>({l,v:values[i]})).sort((a,b)=>b.v-a.v);
        const top = indexed.slice(0,10);
        const otherSum = indexed.slice(10).reduce((s,x)=>s+(x.v||0),0);
        labels = top.map(x=>x.l);
        values = top.map(x=>x.v);
        if (otherSum > 0) { labels.push('Other'); values.push(otherSum); }
    }

    // Decide chart type if missing
    let decidedType = (chart.type || '').toLowerCase();
    if (!decidedType) decidedType = isTimeSeries ? 'line' : 'bar';

    const dataTable = new google.visualization.DataTable();
    dataTable.addColumn('string', 'Label');
    // For comparison on time series, add previous period as second series
    let useComparison = false;
    if (isTimeSeries && values.length >= 8) {
        dataTable.addColumn('number', 'Current');
        dataTable.addColumn('number', 'Previous');
        useComparison = true;
    } else {
        dataTable.addColumn('number', chart.title || 'Value');
    }

    let rows;
    if (useComparison) {
        // Align last n/2 points as current and the n/2 preceding as previous
        const n = values.length;
        const win = Math.floor(n/2);
        const currLabels = rawLabels.slice(n - win);
        const currValues = rawValues.slice(n - win);
        const prevValues = rawValues.slice(n - 2*win, n - win);
        rows = currLabels.map((label, i) => [String(label), Number(currValues[i]||0), Number(prevValues[i]||0)]);
    } else {
        // For premium column/bar charts, add value annotations with short numbers
        if (decidedType === 'bar' || decidedType === 'column') {
            // add annotation role column
            // We add the column after the value column below, so build rows with annotation too
            rows = labels.map((label, idx) => {
                const val = Number(values?.[idx] ?? 0);
                const ann = isNaN(val) ? '' : formatShortNumber(val);
                return [String(label), val, ann];
            });
        } else {
            rows = labels.map((label, idx) => [String(label), Number(values?.[idx] ?? 0)]);
        }
    }
    if (rows.length === 0 && Array.isArray(chart.values)) {
        // fallback if labels missing
        rows.push(['Value', Number((chart.values[0] ?? 0))]);
    }
    // If annotations are present for bar/column, add an annotation column
    const hasAnnotations = !useComparison && (decidedType === 'bar' || decidedType === 'column');
    if (hasAnnotations) {
        dataTable.addColumn({ type: 'string', role: 'annotation' });
    }
    dataTable.addRows(rows);

    const baseColors = [
        ['#0012a9', '#1b2bd6'], // Primary blue gradient
        ['#10b981', '#34d399'], // Success green gradient
        ['#f59e0b', '#fbbf24'], // Warning amber gradient
        ['#ef4444', '#f87171'], // Error red gradient
        ['#8b5cf6', '#a78bfa'], // Purple gradient
        ['#06b6d4', '#22d3ee'], // Cyan gradient
        ['#84cc16', '#a3e635'], // Lime gradient
        ['#f97316', '#fb923c'], // Orange gradient
        ['#ec4899', '#f472b6'], // Pink gradient
        ['#6366f1', '#818cf8']  // Indigo gradient
    ];

    const commonOptions = {
        backgroundColor: 'transparent',
        legend: { 
            position: 'top', 
            alignment: 'start', 
            textStyle: { 
                color: 'var(--text-primary)', 
                fontSize: 13, 
                fontName: 'Inter, sans-serif',
                bold: true
            },
            maxLines: 2,
            itemGap: 20
        },
        titleTextStyle: { 
            color: 'var(--text-primary)', 
            fontSize: 16, 
            bold: true,
            fontName: 'Inter, sans-serif'
        },
        hAxis: { 
            textStyle: { 
                color: 'var(--text-secondary)', 
                fontSize: 12,
                fontName: 'Inter, sans-serif'
            }, 
            gridlines: { 
                color: 'var(--border-light)', 
                count: 5,
                style: 'dashed'
            }, 
            baselineColor: 'var(--border-color)',
            minorGridlines: { color: 'var(--border-light)', count: 1 }
        },
        vAxis: { 
            textStyle: { 
                color: 'var(--text-secondary)', 
                fontSize: 12,
                fontName: 'Inter, sans-serif'
            }, 
            gridlines: { 
                color: 'var(--border-light)', 
                count: 5,
                style: 'dashed'
            }, 
            baselineColor: 'var(--border-color)',
            viewWindowMode: 'explicit', 
            format: 'short',
            minorGridlines: { color: 'var(--border-light)', count: 1 }
        },
        chartArea: { 
            left: 80, 
            top: 40, 
            right: 30, 
            bottom: 70,
            backgroundColor: 'transparent'
        },
        animation: { 
            startup: true, 
            duration: 500, 
            easing: 'out' 
        },
        colors: baseColors.map(c => c[0]),
        focusTarget: 'category',
        tooltip: { 
            textStyle: { 
                color: 'var(--text-primary)', 
                fontSize: 13,
                fontName: 'Inter, sans-serif'
            }, 
            showColorCode: true,
            isHtml: true,
            trigger: 'focus'
        },
        annotations: { 
            textStyle: { 
                color: 'var(--text-primary)', 
                fontSize: 12, 
                fontName: 'Inter, sans-serif',
                auraColor: 'none' 
            }, 
            alwaysOutside: true 
        },
        dataOpacity: 0.95,
        enableInteractivity: true,
        selectionMode: 'multiple'
    };

    const type = decidedType;
    let viz;
    if (type === 'line') {
        viz = new google.visualization.LineChart(target);
        commonOptions.curveType = 'function';
        commonOptions.lineWidth = 4;
        commonOptions.pointSize = 6;
        commonOptions.pointShape = 'circle';
        commonOptions.areaOpacity = 0.2;
        commonOptions.series = {
            0: { 
                lineWidth: 4,
                pointSize: 6,
                pointShape: 'circle'
            }
        };
        if (useComparison) {
            // legend tweaks for comparison
            commonOptions.colors = ['#1f3db3', '#9aa5ff'];
        }
    } else if (type === 'pie') {
        viz = new google.visualization.PieChart(target);
        commonOptions.pieHole = 0.5;
        commonOptions.pieSliceText = 'percentage';
        commonOptions.pieSliceTextStyle = { 
            color: 'var(--text-primary)', 
            fontSize: 13,
            fontName: 'Inter, sans-serif',
            bold: true
        };
        commonOptions.sliceVisibilityThreshold = 0.01;
        commonOptions.slices = {
            0: { offset: 0.1 },
            1: { offset: 0.05 }
        };
        commonOptions.legend = {
            position: 'right',
            alignment: 'center',
            textStyle: { 
                color: 'var(--text-primary)', 
                fontSize: 13,
                fontName: 'Inter, sans-serif',
                bold: true
            }
        };
    } else {
        // Use horizontal bars when labels are long
        const anyLong = labels.some(l=>String(l).length>12) || labels.length>10;
        viz = anyLong ? new google.visualization.BarChart(target) : new google.visualization.ColumnChart(target);
        commonOptions.bar = { 
            groupWidth: '60%',
            gapWidth: 0.2
        };
        commonOptions.series = {
            0: {
                color: baseColors[0][0],
                visibleInLegend: true
            }
        };
        // Simulated gradient by alternating palette for depth
        commonOptions.colors = baseColors.map(([c1, c2], i) => i % 2 === 0 ? c1 : c2);
        // Minimal legend for single series
        if (!useComparison) commonOptions.legend = { position: 'none' };
    }

    let lastDrawOk = false;
    const draw = () => {
        // Adjust margins for very large values/labels
        try {
            const maxLabelLen = (chart.labels || []).reduce((m, l) => Math.max(m, String(l).length), 0);
            if (maxLabelLen > 12) commonOptions.chartArea.bottom = 90;
            const maxVal = Math.max(...(chart.values || [0]).map(v => Number(v || 0)));
            if (maxVal > 1e7) commonOptions.chartArea.left = 100; // more room for formatted ticks like 40,000,000
        } catch(e) {}
        try {
        // Format numeric columns to short pattern for premium readability
        const fmt = new google.visualization.NumberFormat({ pattern: 'short' });
        const currencyFmt = new google.visualization.NumberFormat({ 
            pattern: '¬§#,##0', 
            prefix: '$' 
        });
        // Apply to all numeric columns beyond the first label column
        for (let i = 1; i < dataTable.getNumberOfColumns(); i++) {
            // Check if column contains currency-like values
            const sampleValues = [];
            for (let j = 0; j < Math.min(10, dataTable.getNumberOfRows()); j++) {
                const val = dataTable.getValue(j, i);
                if (val !== null && val !== undefined) sampleValues.push(val);
            }
            const avgValue = sampleValues.reduce((a, b) => a + b, 0) / sampleValues.length;
            if (avgValue > 1000) {
                currencyFmt.format(dataTable, i);
            } else {
                fmt.format(dataTable, i);
            }
        }
        } catch(e) {}
        viz.draw(dataTable, commonOptions);
        lastDrawOk = true;
    };
    if (google.charts && google.charts.setOnLoadCallback) {
        google.charts.setOnLoadCallback(draw);
    } else {
        draw();
    }
    // Redraw on window resize for responsiveness
    window.addEventListener('resize', draw);
    return { 
        destroy: () => { target.innerHTML = ''; },
        download: (name='chart') => {
            try {
                if (!lastDrawOk) draw();
                const uri = viz.getImageURI && viz.getImageURI();
                if (uri) {
                    const link = document.createElement('a');
                    link.download = `${name}.png`;
                    link.href = uri;
                    link.click();
                    return;
                }
            } catch(e) { /* fall back below */ }
            const bg = getComputedStyle(document.documentElement).getPropertyValue('--background-secondary').trim() || '#ffffff';
            html2canvas(target, { backgroundColor: bg, useCORS: true, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${name}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    };
}

// Short number formatter for KPI and ticks
function formatShortNumber(value) {
    const num = Number(value);
    if (!isFinite(num)) return String(value ?? '');
    const abs = Math.abs(num);
    if (abs >= 1e12) return (num/1e12).toFixed(2).replace(/\.00$/, '') + 'T';
    if (abs >= 1e9)  return (num/1e9 ).toFixed(2).replace(/\.00$/, '') + 'B';
    if (abs >= 1e6)  return (num/1e6 ).toFixed(2).replace(/\.00$/, '') + 'M';
    if (abs >= 1e3)  return (num/1e3 ).toFixed(2).replace(/\.00$/, '') + 'K';
    return num.toLocaleString();
}
function openDashboard(charts) {
    const overlay = document.getElementById('dashboardOverlay');
    const grid = document.getElementById('dashboardGrid');
    grid.innerHTML = '';

    // Show first so Google Charts can size properly
    overlay.style.display = 'flex';
    document.body.classList.add('modal-open');

    // Render after layout
    requestAnimationFrame(() => {
        charts.forEach((c, i) => {
            const card = document.createElement('div');
            card.className = 'dashboard-card';
            const h = document.createElement('h4');
            h.textContent = c.title || `Chart ${i + 1}`;
            const target = document.createElement('div');
            target.style.flex = '1';
            target.style.height = '280px';
            card.appendChild(h);
            card.appendChild(target);
            grid.appendChild(card);

            renderChartOrKpi(target, c);
        });
    });
}

function closeDashboard(e) {
    document.getElementById('dashboardOverlay').style.display = 'none';
    document.body.classList.remove('modal-open');
}

async function downloadDashboardPng() {
   
      const div = document.getElementById("dashboardGrid");
      html2canvas(div, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        link.download = "div_capture.png";
        link.href = imgData;
        link.click();
      });
    
    // const grid = document.getElementById('dashboardGrid');
    // if (!grid) return;

    // const overlay = document.getElementById('dashboardOverlay');
    // const modal = overlay ? overlay.querySelector('.dashboard-modal') : null;

    // // Save current layout properties
    // const prev = {
    //     modal: modal ? {
    //         height: modal.style.height,
    //         maxHeight: modal.style.maxHeight,
    //         overflow: modal.style.overflow,
    //     } : null,
    //     grid: {
    //         height: grid.style.height,
    //         overflow: grid.style.overflow,
    //         scrollTop: grid.scrollTop,
    //     },
    //     body: {
    //         overflow: document.body.style.overflow,
    //         height: document.body.style.height,
    //     },
    // };

    // try {
    //     // Wait for animations
    //     await new Promise(r => setTimeout(r, 300));

    //     // --- Expand layout so entire grid is visible ---
    //     document.body.style.overflow = 'visible';
    //     document.body.style.height = 'auto';

    //     if (modal) {
    //         modal.style.height = 'auto';
    //         modal.style.maxHeight = 'none';
    //         modal.style.overflow = 'visible';
    //     }

    //     grid.style.overflow = 'visible';
    //     grid.style.height = 'auto';

    //     await new Promise(r => setTimeout(r, 100)); // Allow reflow

    //     // --- Capture ---
    //     const bg = getComputedStyle(document.documentElement)
    //         .getPropertyValue('--background-secondary').trim() || '#ffffff';

    //     const SCALE = Math.min(2, Math.max(1, window.devicePixelRatio || 1.5));

    //     const canvas = await html2canvas(grid, {
    //         backgroundColor: bg,
    //         useCORS: true,
    //         allowTaint: false,
    //         foreignObjectRendering: false,
    //         logging: false,
    //         scrollX: 0,
    //         scrollY: 0,
    //         width: grid.scrollWidth,
    //         height: grid.scrollHeight,
    //         scale: SCALE,
    //     });

    //     // --- Download image ---
    //     const dataUrl = canvas.toDataURL('image/png');
    //     if (!dataUrl || dataUrl === 'data:,') {
    //         alert('Export failed: empty image. Please try again.');
    //         return;
    //     }

    //     const a = document.createElement('a');
    //     a.download = `dashboard_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.png`;
    //     a.href = dataUrl;
    //     document.body.appendChild(a);
    //     a.click();
    //     a.remove();

    // } catch (e) {
    //     console.error('Dashboard export error:', e);
    //     alert('Could not export dashboard. Please try again.');
    // } finally {
    //     // --- Restore previous layout ---
    //     if (modal && prev.modal) {
    //         modal.style.height = prev.modal.height;
    //         modal.style.maxHeight = prev.modal.maxHeight;
    //         modal.style.overflow = prev.modal.overflow;
    //     }
    //     grid.style.height = prev.grid.height;
    //     grid.style.overflow = prev.grid.overflow;
    //     grid.scrollTop = prev.grid.scrollTop;
    //     document.body.style.overflow = prev.body.overflow;
    //     document.body.style.height = prev.body.height;
    // }
}




document.getElementById('user-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

        // Add welcome message on load
document.addEventListener('DOMContentLoaded', function() {
    const welcomeMessage = createMessageElement('assistant', 
        `# Welcome to BusinessGPT! üöÄ\n\nI'm your AI-powered business analytics assistant with intelligent question classification. I can help you:\n\n- üìä **Analyze sales data** and generate insights\n- üìà **Create visualizations** and charts\n- üîç **Answer business questions** with data-driven responses\n- üí° **Generate reports** and summaries\n- ü§ñ **Smart conversation** - I understand business vs casual questions\n`
    );
    chatMessages.appendChild(welcomeMessage.messageDiv);
    scrollToBottom();
    // Keyboard: ESC to close dashboard
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeDashboard();
    });
});

    // ===== Theme toggle with persistence =====
const themeToggleBtn = document.getElementById('themeToggle');
function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    if (themeToggleBtn) themeToggleBtn.textContent = theme === 'light' ? 'üåû' : 'üåô';
}
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
applyTheme(savedTheme);
if (themeToggleBtn) themeToggleBtn.addEventListener('click', () => {
    const next = (localStorage.getItem('theme') || 'dark') === 'dark' ? 'light' : 'dark';
    localStorage.setItem('theme', next);
    applyTheme(next);
});

// ===== Density toggle (compact / comfortable) =====
let density = localStorage.getItem('density') || 'comfortable';
applyDensity(density);
function applyDensity(mode) {
    const root = document.documentElement;
    if (mode === 'compact') {
        root.style.setProperty('--space-4', '12px');
        root.style.setProperty('--space-5', '16px');
    } else {
        root.style.setProperty('--space-4', '16px');
        root.style.setProperty('--space-5', '20px');
    }
}
function toggleDensity() {
    density = density === 'compact' ? 'comfortable' : 'compact';
    localStorage.setItem('density', density);
    applyDensity(density);
}

const densityToggleBtn = document.getElementById('densityToggle');
if (densityToggleBtn) {
    const setLabel = () => densityToggleBtn.textContent = density === 'compact' ? 'üîé' : '‚ÜïÔ∏è';
    setLabel();
    densityToggleBtn.addEventListener('click', () => { toggleDensity(); setLabel(); });
}

// ===== Keyboard shortcuts =====
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        openCommandPalette();
    }
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
        e.preventDefault();
        startNewChat();
    }
});

// ===== Command palette logic =====
const paletteOverlay = document.getElementById('commandPaletteOverlay');
const paletteInput = document.getElementById('paletteInput');
function openCommandPalette() {
    paletteOverlay.style.display = 'flex';
    setTimeout(() => paletteInput && paletteInput.focus(), 0);
}
function closeCommandPalette(ev) {
    if (!ev || ev.target === paletteOverlay) {
        paletteOverlay.style.display = 'none';
    }
}
document.querySelectorAll('.palette-item').forEach(item => {
    item.addEventListener('click', () => {
        const action = item.getAttribute('data-action');
        runPaletteAction(action);
        paletteOverlay.style.display = 'none';
    });
});
paletteInput && paletteInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const val = (paletteInput.value || '').toLowerCase();
        if (val.includes('upload')) runPaletteAction('upload');
        else if (val.includes('export')) runPaletteAction('export');
        else if (val.includes('chart') || val.includes('create')) runPaletteAction('chart-selection');
        else if (val.includes('dashboard')) runPaletteAction('dashboard');
        else if (val.includes('clear')) runPaletteAction('clear');
        paletteOverlay.style.display = 'none';
    } else if (e.key === 'Escape') {
        paletteOverlay.style.display = 'none';
    }
});
function runPaletteAction(action) {
    switch(action) {
        case 'upload': document.getElementById('fileInput').click(); break;
        case 'export': exportChat(); break;
        case 'chart-selection': openDashboardPicker(); break;
        case 'dashboard': openDashboardFromLast(); break;
        case 'clear': startNewChat(); break;
    }
}

// ===== File upload (drag & drop + browse) =====
const fileArea = document.getElementById('fileUploadArea');
const fileInput = document.getElementById('fileInput');
const fileBrowseLink = document.getElementById('fileBrowseLink');
if (fileBrowseLink) fileBrowseLink.addEventListener('click', () => fileInput.click());
if (fileArea) {
    ;['dragenter','dragover'].forEach(evt => fileArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); fileArea.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(evt => fileArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); fileArea.classList.remove('dragover'); }));
    fileArea.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        handleFiles(files);
    });
}
if (fileInput) fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

function handleFiles(fileList) {
    if (!fileList || fileList.length === 0) return;
    // For now, just show a message that files were received.
    const names = Array.from(fileList).map(f => f.name).join(', ');
    const { messageDiv } = createMessageElement('assistant', `Received files: ${names}\n(Backend upload endpoint not implemented yet)`);
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// ===== Export helpers =====
function exportChat() {
    // Basic export: dump chat text to a file
    const texts = Array.from(document.querySelectorAll('.message .message-content')).map(n => n.innerText).join('\n\n---\n\n');
    const blob = new Blob([texts], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'businessgpt_chat.txt'; a.click();
    URL.revokeObjectURL(url);
}

function downloadResultsAsCSV(results, filename = 'results') {
    if (!results || results.length === 0) {
        alert('No data to download');
        return;
    }
    
    try {
        // Get all unique keys from the results
        const allKeys = [...new Set(results.flatMap(row => Object.keys(row)))];
        
        // Create CSV header
        const headers = allKeys.join(',');
        
        // Create CSV rows
        const rows = results.map(row => {
            return allKeys.map(key => {
                const value = row[key];
                // Handle different data types and escape commas/quotes
                if (value === null || value === undefined) return '';
                if (typeof value === 'string') {
                    // Escape quotes and wrap in quotes if contains comma
                    const escaped = value.replace(/"/g, '""');
                    return escaped.includes(',') || escaped.includes('"') || escaped.includes('\n') 
                        ? `"${escaped}"` 
                        : escaped;
                }
                return value;
            }).join(',');
        });
        
        // Combine header and rows
        const csvContent = [headers, ...rows].join('\n');
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${filename}_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log(`Downloaded ${results.length} rows as CSV`);
    } catch (error) {
        console.error('Error downloading CSV:', error);
        alert('Error downloading CSV file. Please try again.');
    }
}

function downloadChartDataAsCSV(chart) {
    if (!chart || !chart.labels || !chart.values) {
        alert('No chart data to download');
        return;
    }
    
    try {
        const data = [];
        
        // Create data rows
        for (let i = 0; i < chart.labels.length; i++) {
            data.push({
                label: chart.labels[i],
                value: chart.values[i]
            });
        }
        
        // Convert to CSV
        const headers = 'Label,Value';
        const rows = data.map(row => `"${row.label}",${row.value}`);
        const csvContent = [headers, ...rows].join('\n');
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `${chart.title || 'chart'}_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        console.log(`Downloaded chart data as CSV`);
    } catch (error) {
        console.error('Error downloading chart CSV:', error);
        alert('Error downloading chart data. Please try again.');
    }
}

function openDashboardFromLast() {
    // Try to open dashboard using last assistant charts if present
    // Fallback: show a hint
    const lastChartsBtn = document.querySelector('.open-dashboard-btn');
    if (lastChartsBtn) lastChartsBtn.click();
    else alert('No charts available to open as dashboard yet. Ask for an analysis first.');
}

  // Dashboard picker logic
  async function openDashboardPicker() {
    const overlay = document.getElementById('dashboardPickerOverlay');
    const grid = document.getElementById('dashboardPickerGrid');
    grid.innerHTML = '';
    overlay.style.display = 'flex';
    document.body.classList.add('modal-open');

    try {
      // Load dashboards and charts
      const [dashRes, chartRes] = await Promise.all([
        fetch(`${API_BASE}/dashboards/list/${encodeURIComponent(USER_ID)}/${encodeURIComponent(SESSION_ID)}`),
        fetch(`${API_BASE}/charts/list/${encodeURIComponent(USER_ID)}/${encodeURIComponent(SESSION_ID)}`)
      ]);
      const dashData = await dashRes.json();
      const chartData = await chartRes.json();

      // Two-pane enterprise layout
      window.__pickerSelection = new Set();
      const layout = document.createElement('div');
      layout.className = 'chart-selection-layout';

      // Sidebar list
      const aside = document.createElement('aside');
      aside.className = 'chart-selection-sidebar';
      const asideHead = document.createElement('div');
      asideHead.className = 'sidebar-head';
      asideHead.textContent = 'Available Charts';
      const list = document.createElement('div');
      list.id = 'pickerList';
      list.className = 'chart-list';

      // Footer with counts and bulk actions
      const footer = document.createElement('div');
      footer.className = 'chart-selection-footer';
      const footerLeft = document.createElement('div'); footerLeft.className = 'left';
      const footerCount = document.createElement('span'); footerCount.id = 'pickerCountFooter'; footerCount.textContent = '0 selected';
      footerLeft.appendChild(footerCount);
      const footerRight = document.createElement('div'); footerRight.className = 'right';
      const btnAll = document.createElement('button'); btnAll.className = 'dashboard-btn'; btnAll.textContent = 'Select All'; btnAll.onclick = () => window.__pickerSelectAll(true);
      const btnClear = document.createElement('button'); btnClear.className = 'dashboard-btn'; btnClear.textContent = 'Clear'; btnClear.onclick = () => window.__pickerSelectAll(false);
      footerRight.appendChild(btnAll); footerRight.appendChild(btnClear);
      footer.appendChild(footerLeft); footer.appendChild(footerRight);

      aside.appendChild(asideHead);
      aside.appendChild(list);
      aside.appendChild(footer);

      // Preview area
      const preview = document.createElement('section');
      preview.className = 'chart-preview';
      const pHead = document.createElement('div'); pHead.className = 'preview-head';
      const pTitle = document.createElement('div'); pTitle.className = 'dashboard-title'; pTitle.textContent = 'Preview';
      const pActions = document.createElement('div'); pActions.className = 'dashboard-actions';
      const pDownload = document.createElement('button'); pDownload.className = 'dashboard-btn'; pDownload.textContent = 'Download PNG'; pDownload.onclick = () => window.__pickerDownloadPreview();
      pActions.appendChild(pDownload);
      pHead.appendChild(pTitle); pHead.appendChild(pActions);
      const pBody = document.createElement('div'); pBody.className = 'preview-body';
      const pMeta = document.createElement('div'); pMeta.id = 'pickerPreviewMeta'; pMeta.className = 'meta'; pMeta.style.color = 'var(--text-muted)'; pMeta.style.fontSize = '12px';
      const pCanvas = document.createElement('div'); pCanvas.id = 'pickerPreviewCanvas'; pCanvas.className = 'preview-canvas';
      pBody.appendChild(pMeta); pBody.appendChild(pCanvas);
      preview.appendChild(pHead); preview.appendChild(pBody);

      layout.appendChild(aside);
      layout.appendChild(preview);
      grid.appendChild(layout);

      // Build flat chart list
      const allCharts = [];
      (chartData.charts || []).forEach(set => {
        (set.charts || []).forEach((chart, idx) => {
          const id = chart.id || `${set.timestamp}_${idx}`;
          allCharts.push({ id, chart, set });
        });
      });

      const updateCounts = () => {
        const n = (window.__pickerSelection || new Set()).size;
        const hdr = document.getElementById('pickerCounter');
        if (hdr) hdr.textContent = `${n} selected`;
        const cbtn = document.getElementById('pickerCreateBtn');
        if (cbtn) cbtn.disabled = (n === 0);
        const f = document.getElementById('pickerCountFooter');
        if (f) f.textContent = `${n} selected`;
      };

      const showPreview = (chart, set) => {
        const meta = document.getElementById('pickerPreviewMeta');
        const canvasWrap = document.getElementById('pickerPreviewCanvas');
        if (!canvasWrap) return;
        canvasWrap.innerHTML = '';
        if (meta) meta.textContent = `From: "${set.query || chart.source_query || 'N/A'}"`;
        const target = document.createElement('div');
        target.style.height = '100%';
        canvasWrap.appendChild(target);
        renderChartOrKpi(target, chart);
      };

      const makeItem = ({ id, chart, set }, i) => {
        const item = document.createElement('div');
        item.className = 'chart-list-item';
        item.setAttribute('data-id', id);
        item.setAttribute('tabindex', '0');
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = window.__pickerSelection.has(id);
        const body = document.createElement('div');
        const title = document.createElement('div'); title.className = 'title'; title.textContent = chart.title || `Chart ${i + 1}`;
        const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = chart.type ? `${(chart.type || '').toUpperCase()} ‚Ä¢ ${set.timestamp}` : `${set.timestamp}`;
        const thumb = document.createElement('div'); thumb.className = 'thumb'; thumb.textContent = 'Preview';
        body.appendChild(title); body.appendChild(meta); body.appendChild(thumb);
        item.appendChild(cb); item.appendChild(body);
        if (cb.checked) item.classList.add('selected');

        const toggle = () => {
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        };
        item.addEventListener('click', (e) => { if (e.target !== cb) { toggle(); showPreview(chart, set); } });
        item.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); showPreview(chart, set); } });
        cb.addEventListener('change', () => {
          if (cb.checked) window.__pickerSelection.add(id); else window.__pickerSelection.delete(id);
          item.classList.toggle('selected', cb.checked);
          updateCounts();
        });

        return item;
      };

      list.innerHTML = '';
      allCharts.forEach((entry, i) => list.appendChild(makeItem(entry, i)));
      if (!allCharts.length) {
        const empty = document.createElement('div');
        empty.style.color = 'var(--text-muted)'; empty.textContent = 'No charts available yet.';
        list.appendChild(empty);
      } else {
        // initial preview
        const first = allCharts[0];
        showPreview(first.chart, first.set);
      }

      // Bulk helpers
      window.__pickerSelectAll = (on) => {
        document.querySelectorAll('#pickerList .chart-list-item input[type="checkbox"]').forEach(cb => {
          cb.checked = !!on;
          cb.dispatchEvent(new Event('change'));
        });
      };

      window.__pickerDownloadPreview = () => {
        const canvasWrap = document.getElementById('pickerPreviewCanvas');
        if (!canvasWrap) return;
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--background-secondary').trim() || '#fff';
        html2canvas(canvasWrap, { backgroundColor: bg, scale: 2 }).then(canvas => {
          const a = document.createElement('a');
          a.download = 'preview.png';
          a.href = canvas.toDataURL('image/png');
          a.click();
        });
      };

      updateCounts();
    } catch (e) {
      console.error(e);
      grid.innerHTML = '<div style="color:var(--error-color);padding:16px;">Failed to load dashboards.</div>';
    }
  }

  function closeDashboardPicker(ev) {
    const overlay = document.getElementById('dashboardPickerOverlay');
    if (!ev || ev.target === overlay) {
      overlay.style.display='none';
      document.body.classList.remove('modal-open');
    }
  }

  async function createDashboardFromSelection() {
    const overlay = document.getElementById('dashboardPickerOverlay');
    const name = (document.getElementById('pickerDashboardName')?.value || 'My Custom Dashboard');
    const ids = Array.from(window.__pickerSelection || []);
    if (!ids.length) { alert('Select at least one chart'); return; }
    const btn = document.getElementById('pickerCreateBtn'); if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }
    try {
      const res = await fetch(`${API_BASE}/dashboard/create`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: USER_ID, session_id: SESSION_ID, selected_charts: ids.map(id=>({chart_id:id})), dashboard_name: name })
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t}`);
      }
      const data = await res.json();
      if (data.success) {
        overlay.style.display='none'; document.body.classList.remove('modal-open');
        openCustomDashboard(data.dashboard);
      } else {
        alert(data.error || 'Failed to create dashboard');
      }
    } catch(e) {
      console.error(e); alert('Failed to create dashboard');
    }
    finally { if (btn) { btn.disabled = false; btn.textContent = 'Create Dashboard'; } }
  }

  function filterPickerCharts() {
    const q = (document.getElementById('pickerSearch')?.value || '').toLowerCase();
    const list = document.getElementById('pickerList'); if (!list) return;
    Array.from(list.querySelectorAll('.chart-list-item')).forEach(item => {
      const text = item.innerText.toLowerCase();
      item.style.display = text.includes(q) ? '' : 'none';
    });
  }
// Backend API Chart Functions
async function loadChartsFromBackend() {
    try {
        const response = await fetch(`${API_BASE}/charts/list/${encodeURIComponent(USER_ID)}/${encodeURIComponent(SESSION_ID)}`);
        const data = await response.json();
        
        if (data.success) {
            const allCharts = [];
            data.charts.forEach(chartSet => {
                chartSet.charts.forEach(chart => {
                    allCharts.push({
                        ...chart,
                        sourceQuery: chartSet.query,
                        sourceTimestamp: chartSet.timestamp
                    });
                });
            });
            return allCharts;
        } else {
            console.error('Failed to load charts:', data.error);
            return [];
        }
    } catch (error) {
        console.error('Error loading charts:', error);
        return [];
    }
}

// Deprecated prompt flow removed to avoid conflicts; use dashboard picker only

async function createDashboardFromBackend(selectedCharts) {
    const dashboardName = prompt('Enter dashboard name:', 'My Custom Dashboard') || 'My Custom Dashboard';
    
    try {
        const selectedChartData = selectedCharts.map(chart => ({ chart_id: chart.id }));
        
        const response = await fetch(`${API_BASE}/dashboard/create`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: USER_ID, session_id: SESSION_ID, selected_charts: selectedChartData, dashboard_name: dashboardName })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Open dashboard with selected charts
            openCustomDashboard(data.dashboard);
        } else {
            alert('Error creating dashboard: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error creating dashboard:', error);
        alert('Error creating dashboard. Please try again.');
    }
}

function openCustomDashboard(dashboard) {
    const overlay = document.getElementById('dashboardOverlay');
    const grid = document.getElementById('dashboardGrid');
    
    // Update dashboard title
    const title = document.querySelector('.dashboard-title');
    title.textContent = dashboard.name;
    
    grid.innerHTML = '';
    
    // Show modal
    overlay.style.display = 'flex';
    document.body.classList.add('modal-open');
    
    // Render charts
    requestAnimationFrame(() => {
        dashboard.charts.forEach((chart, i) => {
            const card = document.createElement('div');
            card.className = 'dashboard-card';
            
            const header = document.createElement('div');
            header.style.padding = '12px 16px';
            header.style.borderBottom = '1px solid var(--border-color)';
            header.style.background = 'var(--background-tertiary)';
            
            const title = document.createElement('h4');
            title.textContent = chart.title || `Chart ${i + 1}`;
            title.style.margin = '0';
            
            const source = document.createElement('p');
            source.textContent = `From: "${chart.source_query}"`;
            source.style.fontSize = '12px';
            source.style.color = 'var(--text-muted)';
            source.style.margin = '4px 0 0 0';
            
            header.appendChild(title);
            header.appendChild(source);
            
            const target = document.createElement('div');
            target.style.flex = '1';
            target.style.height = '280px';
            target.style.padding = '16px';
            
            card.appendChild(header);
            card.appendChild(target);
            grid.appendChild(card);
            
            // Render the chart
            renderChartOrKpi(target, chart);
        });
    });
}

// Enhanced Dashboard Helper Functions
function getChartIcon(type) {
    const icons = {
        'line': 'üìà',
        'bar': 'üìä', 
        'pie': 'ü•ß',
        'kpi': 'üìä',
        'column': 'üìä',
        'area': 'üìà'
    };
    return icons[type] || 'üìä';
}

function copySqlToClipboard(sql) {
    navigator.clipboard.writeText(sql).then(() => {
        // Show success message
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.backgroundColor = '#28a745';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.backgroundColor = '';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy SQL: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = sql;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.backgroundColor = '#28a745';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.backgroundColor = '';
        }, 2000);
    });
}

function updatePickerCounter() {
    const count = (window.__pickerSelection || new Set()).size;
    const counter = document.getElementById('pickerCounter');
    const btn = document.getElementById('pickerCreateBtn');
    if (counter) {
        counter.textContent = `${count} selected`;
        counter.style.background = count > 0 ? 
            'linear-gradient(135deg, var(--primary-color), var(--primary-light))' : 
            'var(--background-tertiary)';
    }
    if (btn) {
        btn.disabled = count === 0;
        btn.style.opacity = count === 0 ? '0.5' : '1';
    }
}

function filterPickerCharts() {
    const searchTerm = document.getElementById('pickerSearch').value.toLowerCase();
    const cards = document.querySelectorAll('.chart-selection-card');
    
    cards.forEach(card => {
        const title = card.querySelector('.chart-selection-title').textContent.toLowerCase();
        const query = card.querySelector('.chart-selection-meta span').textContent.toLowerCase();
        const matches = title.includes(searchTerm) || query.includes(searchTerm);
        
        card.style.display = matches ? 'block' : 'none';
    });
}
</script>

</body>
</html>













